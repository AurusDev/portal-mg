{% extends "admin/layout.html" %}

{% block content %}
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="{{ url_for('admin.list_users') }}" style="color: var(--text-secondary); text-decoration: none;">&larr;
        Voltar</a>
    <h2 style="margin: 0;">Permissões: {{ user.name }}</h2>
</div>

<form method="POST">
    <div class="admin-card">
        <h3 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">
            Configurações da Conta</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem;">Email</label>
                <input type="text" value="{{ user.email }}" disabled
                    style="width: 100%; padding: 0.5rem; background: #222; border: 1px solid #333; color: #888;">
            </div>

            {% if current_user.role == 'admin' %}
            <div>
                <label for="role" style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem;">Perfil
                    (Role)</label>
                <select name="role" id="role"
                    style="width: 100%; padding: 0.5rem; background: #333; border: 1px solid #444; color: white;">
                    <option value="user" {% if user.role=='user' %}selected{% endif %}>Usuário (Padrão)</option>
                    <option value="manager" {% if user.role=='manager' %}selected{% endif %}>Gestor</option>
                    <option value="admin" {% if user.role=='admin' %}selected{% endif %}>Administrador</option>
                </select>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                    Admins têm acesso total. Gestores podem editar permissões. Usuários acessam apenas o portal.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Systems ACL -->
    {% for category, systems in systems_by_category.items() %}
    <div class="admin-card">
        <h3 style="margin-bottom: 1rem; text-transform: capitalize;">{{ category }}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
            {% for system in systems %}
            <label style="
                display: flex; 
                align-items: center; 
                gap: 0.75rem; 
                padding: 1rem; 
                background: #1a1a1a; 
                border-radius: 8px; 
                cursor: pointer;
                border: 1px solid {% if system.id in user_system_ids %}var(--color-success){% else %}var(--border-color){% endif %};
                transition: border-color 0.2s;">

                <input type="checkbox" name="systems" value="{{ system.id }}" {% if system.id in user_system_ids
                    %}checked{% endif %} style="width: 1.25rem; height: 1.25rem; accent-color: var(--color-success);">

                <div>
                    <strong style="display: block; color: var(--text-primary);">{{ system.name }}</strong>
                    {% if system.is_public %}
                    <span style="font-size: 0.7rem; color: var(--text-muted);">(Público)</span>
                    {% endif %}
                </div>
            </label>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div
        style="position: sticky; bottom: 1rem; background: var(--bg-card); padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: flex-end; gap: 1rem; box-shadow: 0 -4px 10px rgba(0,0,0,0.5);">
        <a href="{{ url_for('admin.list_users') }}" class="btn-sm btn-secondary"
            style="padding: 0.75rem 1.5rem; font-size: 1rem;">Cancelar</a>
        <button type="submit" class="btn-sm btn-primary"
            style="border: none; cursor: pointer; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold;">Salvar
            Alterações</button>
    </div>
</form>
{% endblock %}